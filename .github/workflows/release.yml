name: Create Release

on:
  push:
    tags: ['v*']

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6

      - name: Extract changelog for this version
        id: changelog
        run: |
          # Strip leading 'v' from tag to match CHANGELOG headers like "## [0.1.0]"
          version="${GITHUB_REF_NAME#v}"
          # Extract the section between this version's header and the next
          notes=$(awk -v ver="$version" '
            /^## \[/ { if (found) exit; if (index($0, "[" ver "]")) found=1; next }
            found { print }
          ' CHANGELOG.md)
          # Write to file to preserve newlines
          printf '%s\n' "$notes" > /tmp/release-notes.md

      - name: Create GitHub Release
        run: |
          gh release create "$GITHUB_REF_NAME" \
            --title "$GITHUB_REF_NAME" \
            --notes-file /tmp/release-notes.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
